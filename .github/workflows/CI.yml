name: Build modules

on:
  push:
    paths-ignore:
      - "**/*.md"
      - "**/*.txt"
  pull_request:
    paths-ignore:
      - "**/*.md"
      - "**/*.txt"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  build_prx:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup variables
        run: |
          sudo apt update
          sudo apt install -y llvm lld wget unzip tar
          echo "OO_PS4_TOOLCHAIN=$GITHUB_WORKSPACE/OpenOrbis/PS4Toolchain" >> $GITHUB_ENV
          echo "commit_ver=1.$(git rev-list HEAD --count)" >> $GITHUB_ENV
          echo "commit_hash=$(echo ${GITHUB_SHA} | cut -c1-8)" >> $GITHUB_ENV

      - name: Download OpenOrbis Toolchain
        run: |
          if [ ! -d "$OO_PS4_TOOLCHAIN" ]; then
            echo "Downloading Latest OpenOrbis Toolchain..."
            GITHUB_OWNER="OpenOrbis"
            GITHUB_REPO="OpenOrbis-PS4-Toolchain"
            WORKFLOW_FILE="toolchain.yml"
            ARTIFACT_NAME="toolchain-llvm-18"
            GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"

            LATEST_RUN_URL="https://api.github.com/repos/$GITHUB_OWNER/$GITHUB_REPO/actions/workflows/$WORKFLOW_FILE/runs?per_page=10&status=completed"
            LATEST_RUN_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$LATEST_RUN_URL" | jq -r '.workflow_runs[] | select(.head_repository.owner.login == "OpenOrbis") | .id' | head -1)

            if [ -z "$LATEST_RUN_ID" ]; then
              echo "No workflow runs found for $WORKFLOW_FILE."
              exit 1
            fi

            ARTIFACTS_URL="https://api.github.com/repos/$GITHUB_OWNER/$GITHUB_REPO/actions/runs/$LATEST_RUN_ID/artifacts"
            ARTIFACT_DOWNLOAD_URL=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$ARTIFACTS_URL" | jq -r --arg ARTIFACT_NAME "$ARTIFACT_NAME" '.artifacts[] | select(.name == $ARTIFACT_NAME) | .archive_download_url')

            if [ -z "$ARTIFACT_DOWNLOAD_URL" ]; then
              echo "No artifact named '$ARTIFACT_NAME' found in the latest workflow run."
              exit 1
            fi

            curl -L -o "$ARTIFACT_NAME.zip" -H "Authorization: token $GITHUB_TOKEN" "$ARTIFACT_DOWNLOAD_URL"
            unzip -o "$ARTIFACT_NAME.zip"
            TAR_FILE="$ARTIFACT_NAME.tar.gz"
            [ -f "$TAR_FILE" ] && tar -xzf "$TAR_FILE"
            rm -f "$ARTIFACT_NAME.zip" "$TAR_FILE"
          else
            echo "OpenOrbis Toolchain found in cache, skipping download."
          fi

      - name: Checkout SDK
        uses: actions/checkout@v3
        with:
          repository: ItsJokerZz/GoldHEN_Plugins_SDK
          path: SDK

      - name: Install GoldHEN SDK
        working-directory: SDK
        env:
          OO_PS4_TOOLCHAIN: ${{ env.OO_PS4_TOOLCHAIN }}
          CC: clang
          CXX: clang++
        run: |
          # Build and install SDK with proper sysroot
          make clean
          make install

      - name: Checkout mxml
        uses: actions/checkout@v3
        with:
          repository: illusion0001/mxml
          ref: clang-14
          path: mxml

      - name: Install mini xml
        working-directory: mxml/ps4
        env:
          OO_PS4_TOOLCHAIN: ${{ env.OO_PS4_TOOLCHAIN }}
        run: |
          wget https://raw.githubusercontent.com/bucanero/oosdk_libraries/master/build_rules.mk -O $OO_PS4_TOOLCHAIN/build_rules.mk
          make install PRX_BUILD=1

      - name: Export path to SDK
        working-directory: SDK
        run: echo "GOLDHEN_SDK=$(pwd)" >> $GITHUB_ENV

      - name: Build (Release)
        env:
          OO_PS4_TOOLCHAIN: ${{ env.OO_PS4_TOOLCHAIN }}
        run: make

      - name: Build (Debug)
        env:
          OO_PS4_TOOLCHAIN: ${{ env.OO_PS4_TOOLCHAIN }}
        run: make DEBUG=1

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: goldplugins_${{ env.commit_ver }}-${{ env.commit_hash }}
          path: |
            bin/plugins/prx_final/*.prx
            bin/plugins/prx_debug/*.prx
            bin/plugins/elf_final/*.elf
            bin/plugins/elf_debug/*.elf
          if-no-files-found: error
